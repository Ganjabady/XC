<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>V2XCore | داشبورد تست زنده کانفیگ‌ها</title>
    <!-- Chosen Palette: Midnight Blue & Electric Cyan -->
    <!-- Application Structure Plan: A true Single-Page Application (SPA) focused on client-side interactivity. The architecture is designed for performance and real-time feedback. 1. Initial Load: A lightweight shell loads instantly. 2. Data Fetching: JS fetches a single raw config list generated by a backend script. 3. Client-Side Testing Engine: A pool of JavaScript "workers" tests configs in parallel directly from the user's browser, measuring real-world latency. 4. Dynamic Rendering: Results are rendered into the DOM as they become available, creating a "lazy load" effect. 5. Interactive Controls: UI elements for starting/stopping tests, sorting by latency, and filtering allow users to control the experience. This structure provides the most accurate performance data to the end-user and is highly scalable. -->
    <!-- Visualization & Content Choices: 1. Report Info: Raw list of config URLs. Goal: Provide real-time latency from the user's perspective. Viz/Method: Dynamically populated HTML cards. Interaction: Live sorting by ping, search, one-click copy, QR code modal. Justification: This is the most user-centric approach, showing what's fastest *for them, right now*. Library: Vanilla JS, qrcode.js. 2. Report Info: Test progress and results. Goal: Give clear feedback on the testing process. Viz/Method: Progress bar and dynamic counters. Interaction: Start/Stop buttons. Justification: Provides user control and transparency. Library: Vanilla JS. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Vazirmatn', sans-serif; background-color: #020617; color: #cbd5e1; }
        .card { background-color: #0f172a; border: 1px solid #1e293b; }
        .btn-primary { background-color: #0891b2; color: white; }
        .btn-primary:disabled { background-color: #1e293b; color: #475569; cursor: not-allowed; }
        .btn-secondary { background-color: #334155; color: #e2e8f0; }
        .tab-active { color: #06b6d4; border-color: #06b6d4; }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 400px; max-height: 60vh; }
        .config-card:hover { transform: translateY(-4px); box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.1), 0 8px 10px -6px rgba(6, 182, 212, 0.1); }
    </style>
</head>
<body class="antialiased">

    <!-- Modal QR Code -->
    <div id="qr-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden transition-opacity duration-300 opacity-0">
        <div id="qr-modal-content" class="card rounded-2xl shadow-2xl p-6 w-full max-w-sm text-center transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-bold mb-4 text-white">اسکن کنید</h3>
            <div id="qrcode" class="flex justify-center items-center p-2 bg-white rounded-lg mx-auto w-64 h-64"></div>
            <button id="close-modal-btn" class="mt-6 w-full btn-secondary font-bold py-2 px-4 rounded-lg transition-colors">بستن</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container mx-auto p-4 md:p-6">

        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="flex items-center gap-3">
                <i class='bx bxs-zap text-4xl text-cyan-400'></i>
                <h1 class="text-3xl font-bold text-white">V2XCore <span class="font-light text-slate-400">Live Tester</span></h1>
            </div>
            <a href="https://github.com/Ganjabady/XC" target="_blank" class="px-4 py-2 text-sm font-semibold text-slate-300 hover:text-white hover:bg-slate-700/50 rounded-lg transition-colors flex items-center gap-2">
                <i class='bx bxl-github text-xl'></i> مشاهده در گیت‌هاب
            </a>
        </header>

        <!-- Control Panel & Stats -->
        <section class="card p-6 rounded-2xl mb-8 shadow-lg">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 items-center">
                <!-- Controls -->
                <div class="flex items-center justify-center md:justify-start gap-4">
                    <button id="start-test-btn" class="btn-primary font-bold py-3 px-6 rounded-lg flex items-center gap-2 transition-transform hover:scale-105" disabled><i class='bx bx-play-circle text-2xl'></i>شروع تست</button>
                    <button id="stop-test-btn" class="btn-secondary font-bold py-3 px-6 rounded-lg flex items-center gap-2 transition-transform hover:scale-105 hidden"><i class='bx bx-stop-circle text-2xl'></i>توقف</button>
                </div>
                <!-- Stats -->
                <div class="col-span-2">
                     <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                        <div class="bg-slate-800/50 p-3 rounded-lg"><p class="text-xs text-slate-400">کل کانفیگ‌ها</p><p id="total-stat-tester" class="text-2xl font-bold text-white">0</p></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg"><p class="text-xs text-slate-400">تست شده</p><p id="tested-stat" class="text-2xl font-bold text-cyan-400">0</p></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg"><p class="text-xs text-slate-400">سالم</p><p id="working-stat" class="text-2xl font-bold text-green-400">0</p></div>
                        <div class="bg-slate-800/50 p-3 rounded-lg"><p class="text-xs text-slate-400">بهترین پینگ</p><p id="best-ping-stat" class="text-2xl font-bold text-amber-400">N/A</p></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 w-full bg-slate-700 rounded-full h-2.5"><div id="progress-bar" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%"></div></div>
        </section>
        
        <!-- Filter and Sort -->
        <div class="mb-6 flex flex-col md:flex-row gap-4">
            <div class="relative flex-grow">
                <select id="sub-select" class="w-full appearance-none bg-slate-800/50 border-2 border-slate-700 focus:border-cyan-500 rounded-lg py-3 px-4 outline-none transition-colors"></select>
                <i class='bx bx-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-slate-400'></i>
            </div>
            <div class="relative flex-grow">
                <i class='bx bx-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400'></i>
                <input type="text" id="search-input" placeholder="جستجو..." class="w-full bg-slate-800/50 border-2 border-slate-700 focus:border-cyan-500 rounded-lg py-3 pl-12 pr-4 outline-none transition-colors">
            </div>
        </div>

        <!-- Results Grid -->
        <main id="results-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"></main>
        <div id="initial-message" class="text-center py-20"><i class='bx bx-list-ul text-6xl text-slate-600'></i><p class="mt-4 text-slate-400">یک لیست اشتراک انتخاب کرده و روی "شروع تست" کلیک کنید.</p></div>

        <footer class="text-center mt-12 text-slate-500 text-sm"><p>ساخته شده با ❤️ و ☕️</p></footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const REPO_BASE_URL = "https://raw.githubusercontent.com/Ganjabady/XC/main";
            const ALL_CONFIGS_URL = `${REPO_BASE_URL}/subscriptions/v2ray/all_sub.txt`;
            const STATS_URL = `${REPO_BASE_URL}/reports/stats.json`;
            const MAX_WORKERS = 50;
            const TEST_TIMEOUT_MS = 5000;

            const elements = {
                startBtn: document.getElementById('start-test-btn'),
                stopBtn: document.getElementById('stop-test-btn'),
                resultsGrid: document.getElementById('results-grid'),
                initialMessage: document.getElementById('initial-message'),
                searchInput: document.getElementById('search-input'),
                sortSelect: document.getElementById('sort-select'),
                totalStat: document.getElementById('total-stat-tester'),
                testedStat: document.getElementById('tested-stat'),
                workingStat: document.getElementById('working-stat'),
                bestPingStat: document.getElementById('best-ping-stat'),
                progressBar: document.getElementById('progress-bar'),
                qrModal: document.getElementById('qr-modal'),
                qrModalContent: document.getElementById('qr-modal-content'),
                qrcodeContainer: document.getElementById('qrcode'),
                closeModalBtn: document.getElementById('close-modal-btn'),
                subSelect: document.getElementById('sub-select'),
            };

            let allConfigs = [];
            let testedConfigs = [];
            let isTesting = false;
            let testQueue = [];

            function parseConfig(link) {
                try {
                    if (!link.includes("://")) return null;
                    const url = new URL(link);
                    const host = url.hostname;
                    const port = url.port || (url.protocol === 'vless:' || url.protocol === 'trojan:' ? '443' : '80');
                    const name = decodeURIComponent(url.hash.substring(1)) || host;
                    return { link, name, host, port, protocol: url.protocol.replace(':', '') };
                } catch (e) { return null; }
            }
            
            async function testLatency(host, port) {
                return new Promise(resolve => {
                    try {
                        const ws = new WebSocket(`wss://${host}:${port}`);
                        const timeout = setTimeout(() => { ws.close(); resolve(null); }, TEST_TIMEOUT_MS);
                        const startTime = performance.now();
                        ws.onopen = () => { clearTimeout(timeout); resolve(Math.round(performance.now() - startTime)); ws.close(); };
                        ws.onerror = () => { clearTimeout(timeout); resolve(null); };
                    } catch (e) { resolve(null); }
                });
            }

            async function worker() {
                while (isTesting && testQueue.length > 0) {
                    const config = testQueue.shift();
                    if (!config) continue;
                    const latency = await testLatency(config.host, config.port);
                    if (!isTesting) break;
                    testedConfigs.push(config);
                    if (latency !== null) {
                        config.ping = latency;
                        renderCard(config);
                    }
                    updateStats();
                }
            }

            function renderCard(config) {
                const card = document.createElement('div');
                card.className = 'config-card card p-4 rounded-xl flex flex-col justify-between transition-all duration-300';
                card.dataset.name = config.name.toLowerCase();
                card.dataset.ping = config.ping;
                const protocol = config.protocol.toUpperCase();
                const badgeColor = { VLESS: 'bg-blue-500/20 text-blue-300', VMESS: 'bg-purple-500/20 text-purple-300', TROJAN: 'bg-red-500/20 text-red-300', SS: 'bg-orange-500/20 text-orange-300' }[protocol] || 'bg-slate-500/20 text-slate-300';
                card.innerHTML = `<div><div class="flex justify-between items-start"><p class="font-bold text-white text-sm mb-2 leading-tight">${config.name}</p><span class="px-2 py-0.5 text-xs font-bold rounded-full ${badgeColor}">${protocol}</span></div><p class="text-xs text-slate-400 font-mono">${config.host}</p></div><div class="flex justify-between items-center mt-4"><div class="text-green-400 font-bold text-lg">${config.ping} <span class="text-xs font-normal">ms</span></div><div class="flex items-center gap-1"><button class="copy-btn p-2 rounded-full hover:bg-slate-700 text-slate-400" data-link="${config.link}" title="کپی"><i class='bx bx-copy text-lg'></i></button><button class="qr-btn p-2 rounded-full hover:bg-slate-700 text-slate-400" data-link="${config.link}" title="QR کد"><i class='bx bx-qr text-lg'></i></button></div></div>`;
                elements.resultsGrid.appendChild(card);
            }

            function updateStats() {
                const workingCount = elements.resultsGrid.children.length;
                elements.workingStat.textContent = workingCount;
                elements.testedStat.textContent = testedConfigs.length;
                const progress = allConfigs.length > 0 ? (testedConfigs.length / allConfigs.length) * 100 : 0;
                elements.progressBar.style.width = `${progress}%`;
                if (workingCount > 0) {
                    const pings = Array.from(elements.resultsGrid.children).map(c => parseInt(c.dataset.ping));
                    elements.bestPingStat.textContent = `${Math.min(...pings)}ms`;
                } else {
                    elements.bestPingStat.textContent = 'N/A';
                }
            }

            function sortResults() {
                const sortBy = elements.sortSelect.value;
                const cards = Array.from(elements.resultsGrid.children);
                cards.sort((a, b) => (sortBy === 'ping') ? parseInt(a.dataset.ping) - parseInt(b.dataset.ping) : a.dataset.name.localeCompare(b.dataset.name));
                cards.forEach(card => elements.resultsGrid.appendChild(card));
            }

            async function startTest() {
                if (isTesting || !elements.subSelect.value) return;
                isTesting = true;
                elements.startBtn.classList.add('hidden');
                elements.stopBtn.classList.remove('hidden');
                elements.initialMessage.classList.add('hidden');
                elements.resultsGrid.innerHTML = '';
                testedConfigs = [];
                updateStats();
                
                try {
                    const response = await fetch(elements.subSelect.value);
                    if (!response.ok) throw new Error(`Network response was not ok (${response.status})`);
                    const text = await response.text();
                    allConfigs = text.split('\n').map(parseConfig).filter(Boolean);
                    elements.totalStat.textContent = allConfigs.length;
                    if (allConfigs.length === 0) throw new Error("Subscription file is empty.");
                    testQueue = [...allConfigs];
                    for (let i = 0; i < MAX_WORKERS; i++) { worker(); }
                } catch (error) {
                    console.error("Failed to fetch or process subscription:", error);
                    elements.initialMessage.innerHTML = `<i class='bx bx-error text-6xl text-red-500'></i><p class="mt-4 text-slate-400">خطا در دریافت لیست اشتراک. لطفاً از اتصال خود و معتبر بودن لینک مطمئن شوید.</p>`;
                    elements.initialMessage.classList.remove('hidden');
                    stopTest();
                }
            }

            function stopTest() {
                isTesting = false;
                testQueue = [];
                elements.startBtn.classList.remove('hidden');
                elements.stopBtn.classList.add('hidden');
            }
            
            async function populateSubscriptionDropdown() {
                try {
                    const statsResponse = await fetch(STATS_URL);
                    if (!statsResponse.ok) throw new Error('Failed to fetch stats');
                    const stats = await statsResponse.json();
                    
                    let optionsHtml = '<option value="" disabled selected>یک لیست برای تست انتخاب کنید</option>';
                    optionsHtml += `<option value="${REPO_BASE_URL}/subscriptions/v2ray/all_sub.txt">همه کانفیگ‌ها (${stats.total_configs})</option>`;
                    
                    const sortedCountries = Object.entries(stats.countries).sort((a,b) => a[0].localeCompare(b[0]));
                    sortedCountries.forEach(([country, count]) => {
                        if (country !== "Unknown") {
                            optionsHtml += `<option value="${REPO_BASE_URL}/subscriptions/regions/${country}.txt">${country} (${count})</option>`;
                        }
                    });
                    elements.subSelect.innerHTML = optionsHtml;
                } catch (error) {
                    console.error("Failed to populate subscription dropdown:", error);
                    elements.subSelect.innerHTML = '<option value="">خطا در بارگذاری لیست‌ها</option>';
                }
            }

            // --- EVENT LISTENERS ---
            elements.startBtn.addEventListener('click', startTest);
            elements.stopBtn.addEventListener('click', stopTest);
            elements.sortSelect.addEventListener('change', sortResults);
            elements.subSelect.addEventListener('change', () => {
                elements.startBtn.disabled = !elements.subSelect.value;
            });
            elements.searchInput.addEventListener('input', () => {
                const searchTerm = elements.searchInput.value.toLowerCase();
                Array.from(elements.resultsGrid.children).forEach(card => {
                    card.style.display = card.dataset.name.includes(searchTerm) ? '' : 'none';
                });
            });
            document.body.addEventListener('click', e => {
                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    navigator.clipboard.writeText(copyBtn.dataset.link).then(() => {
                        const originalIcon = copyBtn.innerHTML;
                        copyBtn.innerHTML = "<i class='bx bxs-check-circle text-lg text-green-500'></i>";
                        setTimeout(() => { copyBtn.innerHTML = originalIcon; }, 1500);
                    });
                }
                const qrBtn = e.target.closest('.qr-btn');
                if (qrBtn) {
                    elements.qrcodeContainer.innerHTML = '';
                    new QRCode(elements.qrcodeContainer, { text: qrBtn.dataset.link, width: 256, height: 256, colorDark : "#e2e8f0", colorLight : "#0f172a" });
                    elements.qrModal.classList.remove('hidden');
                    setTimeout(() => { elements.qrModal.classList.add('opacity-100'); elements.qrModalContent.classList.remove('scale-95'); }, 10);
                }
            });
            elements.closeModalBtn.addEventListener('click', () => {
                elements.qrModalContent.classList.add('scale-95');
                elements.qrModal.classList.remove('opacity-100');
                setTimeout(() => elements.qrModal.classList.add('hidden'), 300);
            });
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    elements.tabs.forEach(t => t.classList.remove('tab-active'));
                    tab.classList.add('tab-active');
                    elements.tabContents.forEach(content => content.classList.add('hidden'));
                    document.getElementById(`tab-${tab.dataset.tab}`).classList.remove('hidden');
                });
            });

            // --- INITIALIZATION ---
            populateSubscriptionDropdown();
        });
    </script>
</body>
</html>
